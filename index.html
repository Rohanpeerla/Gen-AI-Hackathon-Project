<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CalmSpace AI Chat</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #34495e, #1f2c3a);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      color: #ecf0f1;
    }
    h2 { color: #ecf0f1; margin-bottom: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }

    /* Mood Tracker */
    #mood-box { margin-bottom: 15px; display: flex; gap: 10px; }
    .mood-btn { padding: 10px 14px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; transition: transform 0.2s; }
    .mood-btn:hover { transform: scale(1.2); }

    #chat-box {
      width: 100%;
      max-width: 650px;
      height: 400px;
      overflow-y: auto;
      border-radius: 20px;
      padding: 15px;
      background: rgba(44, 62, 80, 0.85);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }
    .msg { margin: 6px 0; padding: 10px 14px; border-radius: 14px; max-width: 80%; word-wrap: break-word; line-height: 1.4; }
    .user { background: #16a085; align-self: flex-end; border-bottom-right-radius: 4px; color: #ecf0f1; }
    .ai { background: #2980b9; align-self: flex-start; border-bottom-left-radius: 4px; color: #ecf0f1; }

    #input-box { display: flex; width: 100%; max-width: 650px; }
    #message { flex: 1; padding: 12px; border-radius: 14px; border: none; background: rgba(44,62,80,0.9); color: #ecf0f1; font-size: 15px; }

    /* Buttons */
    #record-btn, #send-btn, #breath-btn {
      margin-left: 10px; border: none; border-radius: 14px; cursor: pointer; font-weight: bold; padding: 12px 18px; transition: all 0.2s ease-in-out;
    }
    #record-btn { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; }
    #record-btn:hover { background: linear-gradient(135deg, #d35400, #c0392b); transform: scale(1.05); }
    #send-btn { background: linear-gradient(135deg, #2980b9, #16a085); color: #fff; }
    #send-btn:hover { background: linear-gradient(135deg, #1c5980, #138066); transform: scale(1.05); }
    #breath-btn { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: #fff; }
    #breath-btn:hover { background: linear-gradient(135deg, #6c3483, #8e44ad); transform: scale(1.05); }

    /* Crisis popup */
    #crisis-popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); justify-content:center; align-items:center; }
    #crisis-content { background:#34495e; color:#ecf0f1; padding:25px; border-radius:18px; width:90%; max-width:420px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.25);}
    #crisis-content h3 { color: #e74c3c; margin-bottom:12px;}
    #close-btn { margin-top:15px; padding:10px 18px; background: linear-gradient(135deg, #16a085, #2980b9); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; }
    #close-btn:hover { background: linear-gradient(135deg, #138066, #1c5980); }
  </style>
</head>
<body>
  <h2>üíô CalmSpace AI Chat</h2>

  <!-- Mood Tracker -->
  <div id="mood-box">
    <button class="mood-btn" data-mood="üòä">üòä</button>
    <button class="mood-btn" data-mood="üòî">üòî</button>
    <button class="mood-btn" data-mood="üò°">üò°</button>
    <button class="mood-btn" data-mood="üòå">üòå</button>
  </div>

  <div id="chat-box"></div>
  
  <div id="input-box">
    <input type="text" id="message" placeholder="Type your thoughts here..." />
    <button id="record-btn">üéôÔ∏è</button>
    <button id="send-btn">Send</button>
    <button id="breath-btn">üí® Breathing</button>
  </div>

  <!-- Crisis Popup -->
  <div id="crisis-popup">
    <div id="crisis-content">
      <h3>We care about your safety üíô</h3>
      <p id="crisis-text"></p>
      <button id="close-btn">Okay</button>
    </div>
  </div>

<script>
const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const recordBtn = document.getElementById("record-btn");
const breathBtn = document.getElementById("breath-btn");
const crisisPopup = document.getElementById("crisis-popup");
const crisisText = document.getElementById("crisis-text");
const closeBtn = document.getElementById("close-btn");
const moodButtons = document.querySelectorAll(".mood-btn");

let currentMood = "";
let fromVoice = false;
let moodAsked = false; // AI asks mood only once

// Add message
function addMessage(content, type) {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("msg", type);
  msgDiv.innerText = content;
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Text-to-speech
function speakText(text) {
  if ('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    utter.rate = 1;
    utter.pitch = 1;
    speechSynthesis.speak(utter);
  }
}

// Send message
async function sendMessage() {
  const text = messageInput.value.trim();

  // Ask mood only once
  if(!moodAsked) {
    addMessage("AI: How are you feeling today? üòäüòîüò°üòå", "ai");
    moodAsked = true;
    return;
  }

  if (!text && !currentMood) return;

  if(text) addMessage("You: " + text, "user");
  messageInput.value = "";

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, mood: currentMood })
    });
    const data = await res.json();
    if (data.reply) {
      if (data.reply.includes("Helpline") || data.reply.includes("helpline")) {
        crisisText.innerText = data.reply;
        crisisPopup.style.display = "flex";
      } else {
        addMessage("AI: " + data.reply, "ai");
        if(fromVoice) speakText(data.reply);
      }
    } else {
      addMessage("Error: " + (data.error || "No reply"), "ai");
    }
    currentMood = "";
    fromVoice = false;
  } catch (err) {
    addMessage("Error: " + err.message, "ai");
  }
}

// Mood selection
moodButtons.forEach(btn => {
  btn.addEventListener("click", async () => {
    currentMood = btn.dataset.mood;
    addMessage(`You selected mood: ${currentMood}`, "user");

    // Send mood immediately to AI
    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mood: currentMood, message: "" })
      });
      const data = await res.json();
      if (data.reply) {
        addMessage("AI: " + data.reply, "ai");
      }
      currentMood = ""; // reset mood after AI response
    } catch (err) {
      addMessage("Error: " + err.message, "ai");
    }
  });
});

breathBtn.addEventListener("click", () => {
  let steps = ["Inhale... üå¨Ô∏è", "Hold... ‚úã", "Exhale... üå™Ô∏è"];
  let i = 0;
  addMessage("Starting breathing exercise...", "ai");
  const interval = setInterval(() => {
    if(i >= steps.length * 4) {
      addMessage("Breathing exercise complete! üå∏", "ai");
      clearInterval(interval);
      return;
    }
    addMessage(steps[i % 3], "ai");
    i++;
  }, 3000);
});

// Send & Enter
sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", e => { if(e.key === "Enter") sendMessage(); });
closeBtn.addEventListener("click", () => { crisisPopup.style.display = "none"; });

// Recording button
let recognizing = false;
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';

  recognition.onstart = () => { recognizing = true; recordBtn.innerText = "üî¥"; };
  recognition.onend = () => { recognizing = false; recordBtn.innerText = "üéôÔ∏è"; };
  recognition.onresult = (event) => {
    messageInput.value = event.results[0][0].transcript;
    fromVoice = true;
    sendMessage();
  };
  recordBtn.addEventListener("click", () => {
    if(recognizing) recognition.stop();
    else recognition.start();
  });
} else {
  recordBtn.disabled = true;
  recordBtn.title = "Speech recognition not supported in this browser";
}
</script>
</body>
</html>
